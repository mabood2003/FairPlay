rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: check if the user is authenticated
    function isAuth() {
      return request.auth != null;
    }

    // Helper: check if the user is the document owner
    function isOwner(uid) {
      return isAuth() && request.auth.uid == uid;
    }

    // Users collection
    match /users/{userId} {
      // Anyone authenticated can read user profiles
      allow read: if isAuth();

      // Users can only create their own profile
      allow create: if isOwner(userId)
        && request.resource.data.uid == userId
        && request.resource.data.reliabilityScore == 100
        && request.resource.data.gamesPlayed == 0
        && request.resource.data.gamesAttended == 0
        && request.resource.data.sports.basketball is number
        && request.resource.data.sports.soccer is number;

      // Users can update their own profile; system updates (Elo, reliability)
      // are allowed for any authenticated user (since they come from game logic)
      allow update: if isAuth();

      // Users cannot delete profiles
      allow delete: if false;
    }

    // Games collection
    match /games/{gameId} {
      // Anyone authenticated can read games
      allow read: if isAuth();

      // Any authenticated user can create a game (they become the host)
      allow create: if isAuth()
        && request.resource.data.hostId == request.auth.uid
        && request.resource.data.status == 'open'
        && request.resource.data.players.size() == 1
        && request.resource.data.players[0] == request.auth.uid;

      // Game updates: authenticated users who are host or player
      allow update: if isAuth()
        && (
          // Host can update game status and results
          resource.data.hostId == request.auth.uid
          // Players can join (add themselves to players array)
          || (request.resource.data.players.hasAll(resource.data.players)
              && request.resource.data.players.size() == resource.data.players.size() + 1
              && request.auth.uid in request.resource.data.players)
          // Players can leave (remove themselves from players array)
          || (resource.data.players.hasAll(request.resource.data.players)
              && request.resource.data.players.size() == resource.data.players.size() - 1
              && !(request.auth.uid in request.resource.data.players))
          // Players can check in (must be in players array)
          || (request.auth.uid in resource.data.players
              && request.resource.data.checkedIn.hasAll(resource.data.checkedIn))
          // Players can confirm results (must be in team1 or team2)
          || (request.auth.uid in resource.data.results.team1
              || request.auth.uid in resource.data.results.team2)
        );

      // Games cannot be deleted
      allow delete: if false;
    }
  }
}
